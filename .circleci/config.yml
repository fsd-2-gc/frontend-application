version: 2.1

jobs:
  run-unit-test:
    docker:
      - image: node:20-alpine
    steps:
      - checkout
      - run:
          name: "Install dependencies"
          working_directory: app
          command: npm ci
      - run:
          name: "Run tests with coverage"
          working_directory: app
          command: npm run test:run -- --coverage
      - persist_to_workspace:
          root: .
          paths:
            - app/coverage

  run-static-code-analysis:
    docker:
      - image: node:20-alpine
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: "Install Sonar scan"
          command: npm install -g @sonar/scan
      - run:
          name: "Run Sonar scan"
          command: |
            sonar \
              -Dsonar.token=$SONAR_DEV_TOKEN \
              -Dsonar.projectKey=$SONAR_DEV_PROJECT_KEY \
              -Dsonar.organization=$SONAR_DEV_ORGANIZATION
              -Dsonar.javascript.lcov.reportPaths=app/coverage/lcov.info

  run-end-to-end-test:
    machine:
      image: ubuntu-2204:current
    steps:
      - checkout
      - run:
          name: "Create app env file"
          working_directory: app
          command: echo "$BASE64_ENV_PROD" | base64 -d > .env
      - run:
          name: "Docker info"
          command: |
            docker --version
            docker compose version || docker-compose --version || true
            docker info | sed -n '1,50p'
      - run:
          name: "Ensure external network exists"
          command: docker network create roosh-shared-network
      - run:
          name: "Start stack with docker-compose.yml"
          command: |
            set -e
            docker compose -f docker-roosh-website/docker-compose.yml up -d
      - run:
          name: "Install dockerize (host)"
          command: |
            set -euo pipefail
            ARCH=$(uname -m)
            case "$ARCH" in
              x86_64|amd64)
                DL_ARCH=amd64
                ;;
              aarch64|arm64)
                DL_ARCH=arm64
                ;;
              *)
                echo "Unsupported architecture: $ARCH â€” defaulting to amd64"
                DL_ARCH=amd64
                ;;
            esac
            DOCKERIZE_VERSION=${DOCKERIZE_VERSION:-v0.7.0}
            URL="https://github.com/jwilder/dockerize/releases/download/${DOCKERIZE_VERSION}/dockerize-linux-${DL_ARCH}-${DOCKERIZE_VERSION}.tar.gz"
            echo "Downloading dockerize ${DOCKERIZE_VERSION} for ${DL_ARCH}"
            echo "URL: $URL"
            curl -fsSL -o /tmp/dockerize.tgz "$URL"
            sudo tar -C /usr/local/bin -xzf /tmp/dockerize.tgz dockerize
            dockerize --version
      - run:
          name: "Wait for http://localhost:3000 (dockerize)"
          no_output_timeout: 10m
          command: |
            set -e
            echo "Waiting for app (http://localhost:3000)"
            if dockerize -wait http://localhost:3000 -timeout 5m -wait-retry-interval 2s; then
              echo "App is up"
            else
              echo "App did not become ready in time"
              echo "===== docker compose ps ====="
              docker compose -f docker-roosh-website/docker-compose.yml ps || true
              echo "===== recent web logs ====="
              docker compose -f docker-roosh-website/docker-compose.yml logs --tail=200 web || true
              exit 1
            fi
      - run:
          name: "Run Cypress E2E tests inside compose cypress service"
          command: |
            set -e
            docker exec -it docker-roosh-website-cypress-1 npx cypress run
      - run:
          name: "Teardown docker compose"
          when: always
          command: |
            docker compose -f docker-roosh-website/docker-compose.yml down -v --remove-orphans || true

  deploy-to-vps-prod:
    docker:
      - image: node:20-alpine
    steps:
      - checkout
      - run:
          name: "Create app env file"
          working_directory: app
          command: echo "$BASE64_ENV_PROD" | base64 -d > .env
      - run:
          name: "Install dependencies and build app"
          working_directory: app
          command: |
            npm ci
            npm run build
      - run:
          name: "Install OpenSSH client and rsync"
          command: apk add --no-cache openssh rsync
      - add_ssh_keys
      - run:
          name: "Upload files using rsync"
          command: |
            rsync -azv --delete \
              -e "ssh -o StrictHostKeyChecking=no" \
              --exclude='.git' \
              --exclude='.circleci' \
              --exclude='*.log' \
              ./ $VPS_USER@$VPS_HOST:$PROD_PROJECT_DIR/
      - run:
          name: "Deploy website on VPS via SSH"
          command: |
            ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST "
              set -euo pipefail
              cd $PROD_PROJECT_DIR/docker-roosh-website
              docker compose -f docker-compose-prod.yml down || true
              docker compose -f docker-compose-prod.yml up -d --build
            "


workflows:
  version: 2
  build-and-test-dev:
    jobs:
      - run-unit-test:
          filters:
            branches:
              only:
                - develop
      - run-end-to-end-test:
          requires:
            - run-unit-test
          filters:
            branches:
              only:
                - develop
      - run-static-code-analysis:
          requires:
            - run-unit-test
            - run-end-to-end-test
          filters:
            branches:
              only:
                - develop
  build-and-deploy-prod:
    jobs:
      - run-unit-test:
          filters:
            branches:
              only:
                - main
      - run-end-to-end-test:
          requires:
            - run-unit-test
          filters:
            branches:
              only:
                - main
      - hold-prod:
          type: approval
          requires:
            - run-unit-test
            - run-end-to-end-test
          filters:
            branches:
              only:
                - main
      - deploy-to-vps-prod:
          requires:
            - hold-prod
          filters:
            branches:
              only:
                - main
